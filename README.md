# FlowerShopBot - Telegram-бот для доставки заказа цветов

## Описание

`FlowerShopBot` - это Telegram-бот, предназначенный для упрощения процесса заказа цветочных букетов. Он проводит пользователей через ряд шагов, включая выбор повода, указание ценового диапазона, предоставление деталей доставки и подтверждение их заказа. Бот использует библиотеку aiogram для взаимодействия с Telegram, конечные автоматы (FSM) для управления потоком диалога и интегрируется с бэкендом Django для хранения и извлечения данных.

Функциональность
1. **Приветствие**:
    - Бот приветствует пользователя и предлагает ознакомиться с условиями использования.
    - Пользователь должен дать согласие на обработку персональных данных перед продолжением.

2. **Выбор события**:
    - Пользователь может выбрать повод: День Рождения, Свадьба, В школу, Без повода или Другой повод.
    - Букеты фильтруются в зависимости от выбранного повода.

3. **Выбор ценового диапазона**:
    - После выбора события пользователь указывает желаемую стоимость букета.

4. **Оформление заказа**:
    - Бот запрашивает имя получателя, адрес доставки, дату и время.

5. **Оплата заказа**:
    - После оформления заказа бот предлагает оплатить его через встроенные платежные системы Telegram.

6. **Консультация флориста**:
    - Пользователь может запросить консультацию флориста, указав свой номер телефона.

7. **Просмотр коллекции**:
    - Возможность просмотреть весь каталог доступных букетов с пагинацией.

8. **Обработка ошибок**:
    - Реализована обработка ошибок для предотвращения сбоев в работе бота.

9. **Сохранение данных**:
    - Все данные о пользователях и заказах сохраняются в базе данных Django.


## Архитектура

Архитектура бота состоит из следующих ключевых компонентов:

-   **`handlers.py`:** Логика обработки команд и взаимодействия с пользователем.
-   **`keyboards.py`:** Создание клавиатур для взаимодействия.
-   **`requests.py`:** Асинхронные запросы к бэкенду Django.
-   **FSM (Finite State Machine):** Управление состояниями диалога.
-   **Бэкенд Django:** Хранение данных о пользователях, заказах и товарах.

## Структура кода

### `handlers.py`

Этот файл содержит основную логику для обработки взаимодействия с пользователем и управления поведением бота. Он включает в себя следующие ключевые функции:

-   `cmd_start`: Обрабатывает команду `/start`.
-   `restart_dialog`: Очищает текущее состояние и перезапускает диалог.
-   `continue_dialog`: Восстанавливает предыдущий диалог.
-   `save_fsm_data`: Сохраняет данные FSM в базу данных.
-   `load_fsm_data`: Загружает данные FSM из базы данных.
-   `to_main`: Возвращает пользователя в главный каталог.
-   `event_form`: Обрабатывает принятие формы согласия.
-   `not_event_form`: Обрабатывает отказ от формы согласия.
-   `catalog`: Показывает категории букетов.
-   `choose_occasion`: Обрабатывает выбор повода для букета.
-   `handle_no_reason`: Обрабатывает случай, когда пользователь не выбрал конкретный повод.
-   `handle_another_reason`: Обрабатывает запросы на консультацию.
-   `handle_regular_reason`: Обрабатывает обычный случай выбора повода.
-   `choose_price`: Обрабатывает выбор ценового диапазона.
-   `category`: Обрабатывает выбор товара.
-   `show_welcome_message`: Отправляет приветственное сообщение.

### `keyboards.py`

Этот файл определяет ответные и встроенные клавиатуры, используемые в боте. Он включает функции для создания:

-   `form_button`: Ответная клавиатура для принятия или отклонения формы согласия.
-   `menu`: Ответная клавиатура для главного меню.
-   `main_menu`: Ответная клавиатура для главного каталога.
-   `continue_button`: Встроенная клавиатура для продолжения диалога.
-   `continue_consult`: Ответная клавиатура для заказа консультации.
-   `create_florist_keyboard`: Встроенная клавиатура для флористов.
-   `create_courier_keyboard`: Встроенная клавиатура для курьеров.
-   `create_pagination_buttons`: Встроенная клавиатура для пагинации.
-   `choice_continue_or_restart`: Встроенная клавиатура для выбора продолжения или перезапуска диалога.
-   `filter_bouquets`: Фильтрует букеты по поводу и цене.
-   `items`: Встроенная клавиатура для отображения товаров.
-   `categories`: Встроенная клавиатура для отображения категорий.
-   `price`: Встроенная клавиатура для отображения ценовых диапазонов.
-   `confirm_phone_keyboard`: Встроенная клавиатура для подтверждения телефонных номеров.
-   `for_another_reason`: Ответная клавиатура для дополнительных опций.

### `requests.py`

Этот файл содержит асинхронные функции для взаимодействия с бэкендом Django. Он включает функции для:

-   `set_user`: Создает или получает пользователя.
-   `get_categories`: Получает все категории.
-   `get_category_item`: Получает товары по категории.
-   `get_item`: Получает товар по ID.
-   `create_order`: Создает заказ.
-   `get_сourier`: Получает курьера.
-   `get_all_items`: Получает все товары.
## Функциональность Models

1. **Пользователь (User)**: Сохраняет данные о пользователе Telegram.
2. **Категории (Category)**: Категории событий (например, День Рождения).
3. **Товар (Item)**: Описание букета (название, цена, состав, фото).
4. **Курьер (Courier)**: Информация о курьерах.
5. **Флорист (Florist)**: Информация о флористах.
6. **Заказы (Order)**: Детали заказа (получатель, адрес, дата доставки).
7. **Состояния FSM (FSMData)**: Хранение текущего состояния пользователя в боте.
8. **Назначения курьерам и флористам**: Модели для управления задачами доставки и обратных звонков.


## Начало работы

### Предварительные требования


- Python 3.12+
- Токен Telegram-бота
- Платежный токен Telegram
- Настроенный бэкенд Django
- Установленные зависимости из requirements.txt


### Установка
 
1. Клонируйте репозиторий:
   ```bash
   git clone <URL>
   cd <directory>
   ```
2. Установите зависимости:
    ```bash
    pip install -r requirements.txt
    ```
3. Необходимо создать `.env` файл:

    ```bash 
    SECRET_KEY=ваш_секретный_ключ
    DEBUG=ваша_настройка
    ALLOWED_HOSTS=ваша_настройка
    TG_BOT_TOKEN=ваш_токен
    PAY_TG_TOKEN=ваш_платежный_токен
    ALLOWED_HOSTS=ваши_данные
    ```
4. Настройте проект Django, указав необходимые параметры в файле `settings.py`.
    ```bash
    LANGUAGE_CODE = 'ru'
    TIME_ZONE = 'Europe/Moscow'
    USE_I18N = True
    USE_TZ = True
    ```
    ```bash
    INSTALLED_APPS = [
        ....
    'your_name_apps',]

    SECRET_KEY = env.str('SECRET_KEY')
    TG_BOT_TOKEN = env.str('TG_BOT_TOKEN')
    PAY_TG_TOKEN = env.str('PAY_TG_TOKEN')
    SECRET_KEY = env.str('SECRET_KEY')
    DEBUG = env.bool('DEBUG', default=False)
    ALLOWED_HOSTS = env.list('ALLOWED_HOSTS')
    ```
5. Создайте базу данных и примените миграции, создайте админ пользователя:
    ```bash
    python manage.py makemigrations
    python manage.py migrate
    python manage.py createsuperuser
    ```
6. Запустите сервер:
    ```bash
    python manage.py runserver
    ```
7. Для запуска бота выполните:
    ```bash
    python manage.py runbot
    ```
8. Откройте админскую панель по адресу: http://127.0.0.1:8000/

## Пример использования
**Запуск бота**
- Отправьте команду /start в чате с ботом.
- Следуйте инструкциям для выбора повода и оформления заказа.

## Дополнительно
- [TG_BOT_TOKEN](https://core.telegram.org/bots/tutorial#obtain-your-bot-token) для работы с телеграмм ботом.

## Лицензия
MIT License.
